apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
data:
  otel-collector-config.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
    exporters:
      otlp:
        endpoint: jaeger-collector:4317
        tls: { insecure: true }
    processors:
      batch: {}
    service:
      pipelines:
        traces: { receivers: [otlp], processors: [batch], exporters: [otlp] }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: otel-collector
spec:
  replicas: 1
  selector: { matchLabels: { app: otel-collector } }
  template:
    metadata: { labels: { app: otel-collector } }
    spec:
      containers:
        - name: otel-collector
          image: otel/opentelemetry-collector:0.104.0
          args: [ "--config=/conf/otel-collector-config.yaml" ]
          volumeMounts: [ { name: cfg, mountPath: /conf } ]
      volumes: [ { name: cfg, configMap: { name: otel-collector-config, items: [ { key: otel-collector-config.yaml, path: otel-collector-config.yaml } ] } } ]
---
apiVersion: v1
kind: Service
metadata:
  name: otel-collector
spec:
  selector: { app: otel-collector }
  ports:
    - name: otlp-grpc
      port: 4317
      targetPort: 4317
